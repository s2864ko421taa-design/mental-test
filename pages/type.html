<script type="module">
import { getTypeInfo } from "../js/characters.js";
import { QUESTIONS } from "../js/questions.js";
import { loadState } from "../js/storage.js";
import { calculateResult, buildCode } from "../js/scoring.js";

const $ = (id) => document.getElementById(id);

try {
  // このページが想定HTMLかチェック（ここがnullなら“別のtype.html”を見てる）
  const elTypeCode = $("typeCode");
  if (!elTypeCode) {
    throw new Error('type.html側に id="typeCode" が存在しない（違うHTMLを読んでる可能性大）');
  }

  // 1) URLの ?t=XXXX があればそれ優先
  const params = new URLSearchParams(location.search);
  let code = params.get("t");

  // 2) なければ storage から回答を拾って計算
  if (!code) {
    const state = loadState?.();
    const answers = state?.answers;

    if (!Array.isArray(answers) || answers.length !== QUESTIONS.length) {
      throw new Error("回答データが見つからない/不足（?t= が無い、または storage の回答が壊れてる）");
    }

    const axis = calculateResult(answers, QUESTIONS);
    code = buildCode(axis);
  }

  // 3) コードからキャラ情報取得
  const info = getTypeInfo(code);

  // 見つからない時の表示
  if (!info) {
    $("notFound").style.display = "";
    $("typeCode").textContent = code;
    throw new Error("Unknown type: " + code);
  }

  // 4) 基本情報反映
  $("typeCode").textContent = info.code || code;
  $("pageTitle").textContent = `タイプ詳細: ${info.code || code}`;
  $("pageSub").textContent = info.axesText || "";
  $("typeLabel").textContent = info.shortLabel || info.label || "";
  $("groupBadge").textContent = info.group || "GROUP";
  $("desc").textContent = info.description || "";

  // 5) リスト反映
  const fillList = (id, arr) => {
    const ul = $(id);
    if (!ul) return;
    ul.innerHTML = "";
    (arr || []).forEach((t) => {
      const li = document.createElement("li");
      li.textContent = t;
      ul.appendChild(li);
    });
  };

  fillList("strengths", info.strengths);
  fillList("cautions", info.cautions);
  fillList("tips", info.tips);

} catch (e) {
  console.error(e);
  alert("タイプ詳細の読み込みに失敗: " + (e?.message || String(e)));
}
</script>
